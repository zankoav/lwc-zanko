/**
 * Created by Nikita.Mikhailov on 13.03.2019.
 */

public with sharing class GFNI_LogExcelExporterQueueable implements Queueable {
    private List<GFNI_LogReportRecord> reportRecords;
    private Id userId;

    public GFNI_LogExcelExporterQueueable(List<GFNI_LogReportRecord> reportRecords, Id userId) {
        this.reportRecords = reportRecords;
        this.userId = userId;
    }

    public void execute(QueueableContext context) {
        User sendToUser = [SELECT Id, Name, Email FROM User WHERE Id = :this.userId];

        System.debug('exporting: ' + this.reportRecords);

        Messaging.EmailFileAttachment attach = new Messaging.EmailFileAttachment();
        Blob excel = Blob.valueOf(GFNI_LogExcelBuilder.generateReportHtmlTemplate(this.reportRecords));
        attach.setBody(excel);
        attach.setFileName('GFNI_Log_export.xls');

        GFNI_Utils.sendEmail('GFNI Log export', 'This export generated by user ' + sendToUser.Name + '\n' + '\n' +
                'Have a nice day!', new String[]{
                sendToUser.Email
        }, attach);
    }
}